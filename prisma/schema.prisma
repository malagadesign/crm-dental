// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Usando PostgreSQL con Supabase
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  secretary
}

enum AppointmentStatus {
  confirmado
  cancelado
  asistio
  no_asistio
}

enum PatientOrigin {
  instagram
  recomendacion
  google
  otro
}

enum LeadOrigin {
  instagram
  google
  facebook
  recomendacion
  otro
}

enum LeadStatus {
  nuevo
  contactado
  convertido
  descartado
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  emailVerifiedAt DateTime? @map("email_verified_at")
  password  String
  role      String   @default("admin") // Laravel usa string, no enum
  rememberToken String? @map("remember_token")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  appointments   Appointment[]
  medicalRecords MedicalRecord[]
  toothEvents    ToothEvent[]
  ignoredDuplicateGroups IgnoredDuplicateGroup[]
  stockMovements StockMovement[]

  @@map("users")
}

model Clinic {
  id        Int      @id @default(autoincrement())
  name      String
  address   String?
  phone     String?
  email     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  appointments Appointment[]

  @@map("clinics")
}

model Patient {
  id         Int           @id @default(autoincrement())
  firstName  String        @map("first_name")
  lastName   String        @map("last_name")
  dni        String?       @unique
  birthDate  DateTime?     @map("birth_date")
  phone      String?
  email      String?
  address    String?
  origin     PatientOrigin @default(otro)
  notes      String?      @db.Text
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  // Relations
  appointments   Appointment[]
  medicalRecords MedicalRecord[]
  leads          Lead[]
  toothEvents    ToothEvent[]
  toothStates    ToothState[]

  @@map("patients")
}

model Treatment {
  id             Int      @id @default(autoincrement())
  name           String
  description    String?
  price          Decimal  @db.Decimal(10, 2)
  durationMinutes Int     @default(30) @map("duration_minutes")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  appointments Appointment[]
  toothEvents  ToothEvent[]

  @@map("treatments")
}

model Appointment {
  id           Int              @id @default(autoincrement())
  patientId    Int              @map("patient_id")
  clinicId     Int              @map("clinic_id")
  treatmentId  Int?             @map("treatment_id")
  userId       Int?             @map("user_id")
  datetimeStart DateTime         @map("datetime_start")
  datetimeEnd   DateTime         @map("datetime_end")
  status       AppointmentStatus @default(confirmado)
  notes        String?
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  // Relations
  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinic        Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  treatment     Treatment?     @relation(fields: [treatmentId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  medicalRecords MedicalRecord[]
  toothEvents   ToothEvent[]

  @@index([userId, datetimeStart, datetimeEnd])
  @@map("appointments")
}

model MedicalRecord {
  id           Int      @id @default(autoincrement())
  patientId    Int      @map("patient_id")
  appointmentId Int?    @map("appointment_id")
  userId       Int?     @map("user_id")
  recordDate   DateTime @map("record_date")
  notes        String
  attachments  String? // JSON como string
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  toothEvents ToothEvent[]

  @@map("medical_records")
}

model ToothEvent {
  id            Int      @id @default(autoincrement())
  patientId     Int      @map("patient_id")
  toothNumber   Int      @map("tooth_number") // FDI: 11-48
  kind          String   // estado/procedimiento (healthy, caries, filled, etc.)
  treatmentId   Int?     @map("treatment_id")
  appointmentId Int?     @map("appointment_id")
  medicalRecordId Int?   @map("medical_record_id")
  note          String?  @db.Text
  eventDate     DateTime @map("event_date")
  createdByUserId Int?   @map("created_by_user_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  treatment     Treatment?     @relation(fields: [treatmentId], references: [id], onDelete: SetNull)
  appointment   Appointment?   @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id], onDelete: SetNull)
  createdByUser User?          @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  toothState    ToothState?    @relation("ToothStateLastEvent")

  @@index([patientId, toothNumber, eventDate(sort: Desc)])
  @@index([appointmentId])
  @@index([medicalRecordId])
  @@map("tooth_events")
}

model ToothState {
  id            Int      @id @default(autoincrement())
  patientId     Int      @map("patient_id")
  toothNumber   Int      @map("tooth_number") // FDI: 11-48
  currentStatus String   @map("current_status")
  lastEventId   Int?     @unique @map("last_event_id")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  patient     Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  lastEvent   ToothEvent? @relation("ToothStateLastEvent", fields: [lastEventId], references: [id], onDelete: SetNull)

  @@unique([patientId, toothNumber])
  @@map("tooth_states")
}

model Lead {
  id        Int       @id @default(autoincrement())
  firstName String?   @map("first_name")
  lastName  String?   @map("last_name")
  phone     String?
  email     String?
  origin    LeadOrigin @default(instagram)
  message   String?
  status   LeadStatus @default(nuevo)
  patientId Int?      @map("patient_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  patient Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  @@map("leads")
}

model IgnoredDuplicateGroup {
  id        Int      @id @default(autoincrement())
  groupHash String   @unique @map("group_hash") // Hash de los IDs del grupo ordenados
  patientIds String  @map("patient_ids") // JSON array de IDs de pacientes del grupo
  reason    String?  // Razón opcional por la que se ignoró
  ignoredBy Int?     @map("ignored_by") // ID del usuario que lo ignoró
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ignoredByUser User? @relation(fields: [ignoredBy], references: [id], onDelete: SetNull)

  @@map("ignored_duplicate_groups")
}

enum MaterialUnit {
  unidades
  cajas
  kg
  litros
  paquetes
  rollos
  frascos
  bidones
  bolsas
  kits
  packs
}

enum StockMovementType {
  entrada
  salida
  ajuste
}

model Material {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  unit        MaterialUnit @default(unidades)
  price       Decimal? @db.Decimal(10, 2) // Nullable según SQL V2
  minStock    Decimal  @default(0) @map("min_stock") // Stock mínimo antes de alertar
  currentStock Decimal @default(0) @map("current_stock") // Stock actual
  targetStock Decimal  @default(0) @map("target_stock") // Stock objetivo para reposición
  category    String?  // Categoría opcional (consumibles, materiales dentales, instrumentos, etc.)
  active      Boolean  @default(true)
  deletedAt   DateTime? @map("deleted_at")
  sku         String?  @unique // Código interno único opcional
  critical    Boolean  @default(false) // Material crítico
  consumable  Boolean  @default(true) // Si es consumible
  purchaseUnitLabel String? @map("purchase_unit_label") // Etiqueta de unidad de compra
  purchaseUnitSize Decimal? @db.Decimal(10, 2) @map("purchase_unit_size") // Tamaño de unidad de compra
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  stockMovements StockMovement[]

  @@index([category])
  @@index([active])
  @@index([sku])
  @@map("materials")
}

model StockMovement {
  id          Int      @id @default(autoincrement())
  materialId  Int      @map("material_id")
  type        StockMovementType // entrada, salida, ajuste
  quantity    Decimal  @db.Decimal(10, 2) // Cantidad (positiva para entrada, negativa para salida)
  reason      String?  @db.Text // Motivo/nota del movimiento
  userId      Int?     @map("user_id") // Usuario que realizó el movimiento
  metadata    Json?    // JSONB para metadata adicional (ej: clinicId, clinicName)
  movementDate DateTime @default(now()) @map("movement_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([materialId, movementDate(sort: Desc)])
  @@index([type])
  @@map("stock_movements")
}
